---
title: Supplemetanl Figures for MtD2 transfer from immune cells in mice.
author: 
- name: Nick Borcherding
  email: ncborch@gmail.com
  affiliation: Washington University in St. Louis, School of Medicine, St. Louis, MO, USA
date: "April 8th, 2021"
output:
  BiocStyle::html_document:
    toc_float: true
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{MtD2 Data Analysis}
  %\usepackage[UTF-8]{inputenc}
---


```{r}
library(flowCore)
library(CATALYST)
library(viridis)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggthemes)
library(readxl)
library(RColorBrewer)
```

# Examining Cellular Distribution and markers for clusters
```{r}
tmp <- readRDS("./data/processed/integratedDF.rds")

table <- as.data.frame(table(tmp$cluster.sq, tmp$tissue))
table <- table %>%
  group_by(Var2) %>%
  mutate(sum = sum(Freq))

table$scale <- table$Freq/table$sum


ggplot(table, aes(x = Var1, y = scale, fill = Var2)) +
  geom_bar(stat = "identity", position = "fill") + 
  coord_flip() + 
  scale_fill_manual(values = viridis_pal()(3)) 
  #theme_void() + 
 # guides(fill = F)
ggsave("distribution.pdf", height = 4, width = 3)


plot <- ggplot(tmp, aes(x = X1, y = X2)) + 
  geom_point(color = "grey", size = 0.5, stroke = 0) + 
  theme_void()

p1 <- plot + 
  stat_density_2d(subset(tmp, tissue == "eWAT"), mapping = aes(x = X1, y = X2, fill = ..level..), geom = "polygon")  + 
    scale_fill_viridis() + 
    guides(fill = F) + 
    theme_void() + 
    theme(strip.background = element_blank(),
      strip.text = element_blank())

p2 <- plot + 
  stat_density_2d(subset(tmp, tissue == "iWAT"), mapping = aes(x = X1, y = X2, fill = ..level..), geom = "polygon")  + 
    scale_fill_viridis() + 
    guides(fill = F) + 
    theme_void() + 
    theme(strip.background = element_blank(),
      strip.text = element_blank())

p3 <- plot + 
  stat_density_2d(subset(tmp, tissue == "BAT"), mapping = aes(x = X1, y = X2, fill = ..level..), geom = "polygon")  + 
    scale_fill_viridis() + 
    guides(fill = F) + 
    theme_void() + 
    theme(strip.background = element_blank(),
      strip.text = element_blank())

library(patchwork)
p1 + p2 + p3 + plot_layout(ncol = 1)
ggsave("distribution.png", height = 9, width = 3, dpi = 600)
```

# heatmap of markers
```{r}
tmp2 <- tmp[,c(1,11:45)]
heatmap <- tmp2 %>%
  group_by(cluster.sq) %>%
  summarise(across(1:35, mean)) %>%
  as.data.frame()

rownames(heatmap) <- paste0("X", 1:nrow(heatmap))
headers <- data.frame(heatmap[,1])
rownames(headers) <- paste0("X", 1:nrow(headers))
colnames(headers) <- "cluster"
headers$cluster <- paste0("C", 1:nrow(headers))
matrix <- heatmap[,c(2:12,14:29, 31:32)]


normalize <- function(x)
{
    (x- min(x)) /(max(x)-min(x))
}

for (i in seq_len(ncol(matrix))) {
  matrix[,i] <- normalize(matrix[,i])
}

clusters<- colorRampPalette(brewer.pal(8, "Set1"))(length(unique(tmp$cluster.sq)))
names(clusters) <- paste0("C",1:21)
colors <- list(cluster = clusters)


#Plotting

pdf("Marker.hetmap.pdf", height = 6, width = 5)
pheatmap::pheatmap(t(matrix), scale = "none", show_colnames = FALSE, annotation_col = headers, annotation_colors = colors, fontsize = 6, color = viridis_pal()(50))
dev.off()



```

```{r}
'%!in%' <- Negate("%in%")
subPlot <- function(dat, marker, cut.point, sample.size) {
  dat2 <- dat[which(dat[,marker] <= quantile(dat[,marker], cut.point)),]
  dat2 <- dat2[sample(nrow(dat2), sample.size),]
  return(dat2)
}


CD45 <- ggplot(subPlot(tmp, 'CD45', 0.99, 100000), aes(x = X1, y = X2)) + 
  geom_point(aes(color = normalize(CD45)), size = 0.5) + 
  theme_void() + 
  ggtitle("CD45") + 
  scale_color_viridis(trans = "exp") + 
  guides(color = FALSE)+ 
  theme(plot.title = element_text(hjust = 0.5))


MHC.II <- ggplot(subPlot(tmp, 'MHC.II', 0.99, 100000), aes(x = X1, y = X2)) + 
  geom_point(aes(color = normalize(MHC.II)), size = 0.5) + 
  theme_void() + 
  ggtitle("MHC-II") + 
  scale_color_viridis(trans = "exp")+ 
  guides(color = FALSE)+ 
  theme(plot.title = element_text(hjust = 0.5))

TCRb <- ggplot(subPlot(tmp, 'TCRb', 0.99, 100000), aes(x = X1, y = X2)) + 
  geom_point(aes(color = normalize(TCRb)), size = 0.5, stroke = 0) + 
  theme_void() + 
  ggtitle("TCRb") + 
  scale_color_viridis(trans = "exp")+ 
  guides(color = FALSE)+ 
  theme(plot.title = element_text(hjust = 0.5))


CD11b <- ggplot(subPlot(tmp, 'CD11b', 0.99, 100000), aes(x = X1, y = X2)) + 
  geom_point(aes(color = normalize(CD11b)), size = 0.5) + 
  theme_void() + 
  ggtitle("CD11b") + 
  scale_color_viridis(trans = "exp")+ 
  guides(color = FALSE)+ 
  theme(plot.title = element_text(hjust = 0.5))


CD206 <- ggplot(subPlot(tmp, 'CD206', 0.99, 100000), aes(x = X1, y = X2)) + 
  geom_point(aes(color = normalize(CD206)), size = 0.5) + 
  theme_void() + 
  scale_color_viridis(trans = "exp") + 
  ggtitle("CD206") + 
  guides(color = FALSE)+ 
  theme(plot.title = element_text(hjust = 0.5))

CD11c <- ggplot(subPlot(tmp, 'CD11c', 0.99, 100000), aes(x = X1, y = X2)) + 
  geom_point(aes(color = normalize(CD11c)), size = 0.5) + 
  theme_void() + 
  ggtitle("CD11c") + 
  scale_color_viridis(trans = "exp")+ 
  guides(color = FALSE) + 
  theme(plot.title = element_text(hjust = 0.5))

Ly6C <- ggplot(subPlot(tmp, 'Ly6C', 0.99, 100000), aes(x = X1, y = X2)) + 
  geom_point(aes(color = normalize(Ly6C)), size = 0.5) + 
  theme_void() + 
  ggtitle("Ly6C") + 
  scale_color_viridis(trans = "exp")+ 
  guides(color = FALSE)+ 
  theme(plot.title = element_text(hjust = 0.5))

Ly6G <- ggplot(subPlot(tmp, 'Ly6G', 0.99, 100000), aes(x = X1, y = X2)) + 
  geom_point(aes(color = normalize(Ly6G)), size = 0.5) + 
  theme_void() + 
  ggtitle("Ly6G") + 
  scale_color_viridis(trans = "exp")+ 
  guides(color = FALSE)+ 
  theme(plot.title = element_text(hjust = 0.5))

CD64 <- ggplot(subPlot(tmp, 'CD64', 0.99, 100000), aes(x = X1, y = X2)) + 
  geom_point(aes(color = normalize(CD64)), size = 0.5) + 
  theme_void() + 
  ggtitle("CD64") + 
  scale_color_viridis(trans = "exp")+ 
  guides(color = FALSE)+ 
  theme(plot.title = element_text(hjust = 0.5))


CD45 + TCRb + Ly6C + Ly6G + CD11b + CD11c +  MHC.II  + CD206 + CD64 + plot_layout(ncol = 3)
ggsave("myeloidMarkers.png", height = 9, width = 10.5, dpi = 600)
```
